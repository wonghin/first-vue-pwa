<script setup lang="ts">
import { useGetOnePokemonByProps, useGetPokmonSpecies } from "@/api/pokemonApi";
import { usePokemonItemStore } from "@/hooks/usePokemonItemStore";
import { storeToRefs } from "pinia";
import PokemonEvolutionChain from "./PokemonEvolutionChain.vue";
import { ref } from "vue";
import _ from "lodash";
import { watch } from "vue";
import { useDisplay } from "vuetify/lib/framework.mjs";

const pokemonItem = usePokemonItemStore();
const { name, id } = storeToRefs(pokemonItem);
const { xs, sm } = useDisplay();

const { isError, error, isFetching, data } = useGetOnePokemonByProps(id, true);
// const data = reactive<PokemonItem>(myData)

const {
  data: speciesData,
  isFetching: speciesFetching,
  isLoading: speciesLoading,
} = useGetPokmonSpecies(id);

const total = ref<number>(0);
watch(data, (data) => {
  let sum = 0;
  _.map(data?.stats, (item) => (sum += item.base_stat));
  total.value = sum;
});
</script>

<template>
  <v-navigation-drawer
    location="bottom"
    temporary
    v-model="pokemonItem.isPokemonItemOpen"
    style="height: 80vh; z-index: 9999"
    touchless
    class="rounded-t-xl"
  >
    <div v-if="isFetching"></div>
    <!-- <div v-else-if="isError">{{ error.message }}</div> -->
    <v-icon
      color="grey-darken-3"
      icon="mdi-chevron-left"
      size="50px"
      :style="{
        position: 'absolute',
        top: xs ? '120px' : 0,
        bottom: 0,
        margin: xs ? '' : 'auto',
        left: '0',
      }"
      @click="pokemonItem.id--"
    ></v-icon>
    <v-icon
      color="grey-darken-3"
      icon="mdi-chevron-right"
      size="50px"
      :style="{
        position: 'absolute',
        top: xs ? '120px' : 0,
        bottom: 0,
        margin: xs ? '' : 'auto',
        right: '0',
      }"
      @click="pokemonItem.id++"
    ></v-icon>
    <v-btn
      elevation="0"
      icon="mdi-close"
      style="position: absolute; top: 10px; left: 10px"
      @click="pokemonItem.isPokemonItemOpen = !pokemonItem.isPokemonItemOpen"
    >
    </v-btn>
    <div class="ma-4">
      <v-container fluid v-if="data">
        <div class="d-flex justify-center">
          <div>
            <!-- <div style="height: 20vw; width: 20vw; background-color: brown" class="elevation-6"></div> -->
            <div class="d-flex justify-space-between">
              <!-- <v-img
                height="30vw"
                width="30vw"
                max-height="300px"
                max-width="300px"
                class="bg-grey-darken-3"
              ></v-img> -->
              <v-img
                :src="
                  data.sprites.versions?.['generation-v']['black-white']
                    .animated?.front_default
                "
                height="30vw"
                width="30vw"
                max-height="300px"
                max-width="300px"
              ></v-img>

              <!-- <v-img
                :src="data.sprites.versions?.['generation-v']['black-white'].animated?.back_default"
                height="30vw"
                width="30vw"
                max-height="300px"
                max-width="300px"
              ></v-img> -->
            </div>
            <div class="d-flex justify-center mt-8">
              {{ data.species.name }}
            </div>
            <div class="text-center">
              <v-chip
                v-if="data"
                v-for="(item, index) in data.types"
                :key="index"
                class="mr-2 mt-2"
              >
                {{ item.type.name }}
              </v-chip>
            </div>
            <v-divider class="mt-6 border-opacity-25"></v-divider>
          </div>
        </div>
      </v-container>
      <div class="d-flex align-center flex-column" v-if="data">
        <div
          v-for="(stat, i) in data.stats"
          :key="i"
          class="d-flex flex-column"
          style="width: 40vw; min-width: 300px; max-width: 500px"
        >
          <div class="d-flex align-center justify-space-between">
            <div>{{ stat.stat.name }}:</div>
            <div style="width: 30vw; max-width: 200px">
              <v-progress-linear
                :model-value="(stat.base_stat / 200) * 100"
                bg-color="pink-lighten-3"
                color="pink-lighten-1"
                height="8"
              >
                <div style="font-size: xx-small">{{ stat.base_stat }}</div>
              </v-progress-linear>
            </div>
          </div>
          <!-- <div v-if="i === data.stats.length - 1" class="mt-2">
            Total :{{ total }}
          </div> -->
        </div>
        <div class="mt-4">Total: {{ total }}</div>
        <div class="mt-10">
          <!-- <div v-if="speciesFetching">loading...</div>
          <div v-else-if="speciesData">capture rate: {{ speciesData.capture_rate }}</div> -->
        </div>
        <div v-if="speciesFetching"></div>
        <div v-else-if="speciesData">
          <PokemonEvolutionChain
            :evolutionChainUrl="speciesData.evolution_chain.url"
            :name="name"
            :id="id"
          />
        </div>
      </div>
    </div>
  </v-navigation-drawer>
</template>
